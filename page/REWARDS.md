# REWARDS — نظام النقاط والمكافآت (Gluceel)

> **الغرض**: تحفيز السلوك الصحي الآمن (قياس منتظم، وجبات ضمن الهدف، علاج الهبوط الصحيح، وقت داخل المدى) بدون تشجيع سلوكيات خطيرة.  
> **النطاق**: طفل واحد في كل مرة. جميع الأوقات تُحسب بالتوقيت المحلي للمستخدم (Asia/Kuwait).

---

## مبادئ السلامة
- لا نمنح نقاطًا على “انخفاض القيم” أو “أعلى تصحيح” أو أي سلوك محفوف بالمخاطر.
- لا نخصم نقاطًا؛ عند السلوك غير المرغوب فيه **لا تُمنح نقاط** فقط.
- حساب **TIR/TBR/TAR** يعتمد على جدول `targets` الساري وقت **observed_at** في `measurements`.
- اليوم يُقفل عند 23:59:59 بالتوقيت المحلي. إعادة الاحتساب ممكنة إذا أُضيفت بيانات متأخرة.

---

## مصفوفة النقاط (Reference)

### يومي (Daily)
| الرمز (reason_code) | الوصف | النقاط | الحد اليومي | شروط الإتاحة | مفتاح التفريد (Idempotency) |
|---|---|---:|---:|---|---|
| `daily_tir_80` | TIR اليوم ≥ 80% | 20 | 1×/يوم | حد أدنى قياسات اليوم ≥ **4** | `child_id + day + 'daily_tir'` |
| `daily_tir_70` | TIR اليوم ≥ 70% | 15 | 1×/يوم | نفس الشرط | نفس المفتاح (تُمنح الأعلى فقط) |
| `daily_tir_60` | TIR اليوم ≥ 60% | 10 | 1×/يوم | نفس الشرط | نفس المفتاح (تُمنح الأعلى فقط) |
| `bonus_no_severe_lows` | لا يوجد هبوط **شديد** اليوم | 5 | 1×/يوم | لا قياسات في نطاق **severe_low** أو أقل | `child_id + day + code` |
| `routine_slot` | إتمام فتحة قياس (استيقاظ/قبل الوجبات/قبل النوم) | 2 | **حتى 10**/يوم | الفتحات: `wake, pre_breakfast, pre_lunch, pre_dinner, bedtime` | `child_id + day + slot_name` |
| `meal_within_goal` | وجبة ضمن هدف الكارب | 4 | **حتى 12**/يوم | مقارنة `meal` بـ `child_carb_goals` (basis = net/total) | `child_id + day + meal_id` |
| `snack_within_goal` | سناك ضمن هدف الكارب | 2 | **حتى 4**/يوم | نفس المقارنة | `child_id + day + meal_id` |
| `low_treated_correctly` | علاج هبوط صحيح (قياس متابعة خلال ≤15د وارتفاع ≥15 mg/dL) | 5 | 1×/يوم | حدث Low واحد على الأقل تم علاجه بنجاح | `child_id + day + code` |
| `education_quiz_done` *(اختياري)* | إكمال نشاط توعوي قصير | 3 | 1×/يوم | نشاط واحد معتمد | `child_id + day + code` |

> **ملاحظة:** النقاط اليومية لــ TIR تمنح **الأعلى فقط** (80% > 70% > 60%) عبر نفس مفتاح التفريد.

### أسبوعي / شهري
| الرمز | الوصف | النقاط | الحد | شروط | المفتاح |
|---|---|---:|---:|---|---|
| `streak_7d_tir70` | سلسلة 7 أيام متتالية TIR ≥ 70% | 30 | عند الاكتمال | يتحقق على نافذة منزلقة 7 أيام | `child_id + end_day + code` |
| `a1c_improved_0_3` | تحسّن HbA1c ≥ 0.3% خلال ≤90 يوم | 20 | 1×/90 يوم | مقارنة آخر نتيجتين في `lab_items` (`hba1c`) | `child_id + lab_id + code` |
| `care_task_done` | إتمام مهمة رعاية | من `care_tasks.points_reward` | لكل مهمة | عند التحويل إلى `done` | `child_id + task_id` |

---

## تعريف الفتحات اليومية (Routine Slots)
- `wake`, `pre_breakfast`, `pre_lunch`, `pre_dinner`, `bedtime`
- تُحسب الفتحة مكتملة إذا وُجدت قراءة في نافذتها (اعتمادًا على `user_settings.default_meal_times` ونوافذ `pre_window_mins`).  
- يطبّق حد أقصى **+10** نقاط/يوم عبر مجموع فتحات اليوم.

---

## شروط القواعد (تفصيلي)

### 1) TIR اليوم (daily_tir_*)
- تُجمع القياسات لكل يوم محلي. لو القياسات < **4** → لا تُمنح نقاط TIR.
- تَصنيف القراءة يتم بمقارنة `glucose_mgdl` بحدود `targets` الفعّالة عند `observed_at`.
- نحسب: **Inside Range** ÷ **Total Eligible** × 100.  
- تُمنح أعلى شريحة مستوفاة فقط (80% أو 70% أو 60%).

### 2) لا هبوط شديد (bonus_no_severe_lows)
- لا قياسات في نطاق `severe_low` أو `critical_low` خلال اليوم.

### 3) وجبة/سناك ضمن الهدف
- نحسب **Net/Total** للوجبة حسب `child_carb_goals.evaluation_basis` (أو سياسة الوجبة).  
- مقارنة `meals.net_carbs/total_carbs` بهدف الوجبة من `per_meal` مع `tolerance_g` (أو `%` إن محدد).
- تحتسب السناك عبر هدف خاص بالسناك؛ تُطبّق الحدود اليومية.

### 4) علاج الهبوط الصحيح (low_treated_correctly)
- قراءة Low (< `low_mgdl`) ثم متابعة خلال ≤ **15 دقيقة** تظهر **ارتفاعًا ≥ 15 mg/dL** عن قراءة الـ Low الأولى.

### 5) السلسلة 7 أيام (streak_7d_tir70)
- فحص نافذة منزلقة 7 أيام: كل يوم فيها يحقق `daily_tir_70` أو أعلى.
- يمنح مرة عند اكتمال كل سلسلة جديدة؛ المفتاح يستخدم `end_day` لمنع التكرار.

### 6) تحسّن A1c (a1c_improved_0_3)
- قراءة `hba1c` جديدة أفضل من السابقة بفارق ≥ **0.3%** وخلال ≤ **90 يومًا**.
- حد أقصى منحة واحدة لكل **90 يومًا**.

---

## منع التلاعب (Anti‑Gaming)
- **لا** تُمنح TIR اليومية إن كانت القياسات أقل من 4 في اليوم.
- لكل سبب **مفتاح تفريد** (Idempotency Key) يمنع المنح المكرر لنفس الحدث.
- نقاط الفتحات اليومية عبر `routine_slot` فقط، ولا يوجد `routine_full` منفصل لتجنب الازدواج.
- لا تمنح نقاط على قياسات post-only دون pre بصفة متكررة في اليوم نفسه (يمكن وضع حد أدنى لعدد فتحات pre خلال الأسبوع لفتح إنجازات معيّنة — لاحقًا).

---

## جداول قاعدة البيانات المستخدمة
- `rewards_points_ledger` — دفتر العمليات (مصدر الحقيقة).  
- `rewards_daily_scores` — كاش يومي سريع.  
- `rewards_achievements_catalog` — كتالوج الإنجازات.  
- `rewards_child_achievements` — إنجازات الطفل المكتسبة.  
- (اختياري) `rewards_streaks`, `rewards_catalog`, `rewards_redemptions` للمتجر.

**روابط منطقية (اختيارية لكل عملية):** `measurement_id`, `meal_id`, `care_task_id`, `lab_id`.

---

## سياسة الإعادة (Recompute)
- زر “إعادة احتساب اليوم/الأسبوع” يقوم بتوليد جميع القواعد لليوم/الفترة (Idempotent؛ يستعمل مفاتيح التفريد).
- مهمة ليلية (Job) تمنح نقاط اليوم السابق تلقائيًا.
- أي تعديل متأخر على وجبة/قياس يؤدي إلى إعادة حساب عند طلب المستخدم.

---

## واجهة صفحة المكافآت (Wireframe مبسّط)

**الرأس (Header):**
- رصيد النقاط الإجمالي + مستوى الطفل (Bronze 0–199، Silver 200–499، Gold 500+).
- حلقة الأسبوع: TIR أسبوعي + هدف (مثلاً 70%). زر “إعادة احتساب الأسبوع”.

**عمود يسار (أو قسم علوي على الموبايل): “مهام اليوم”**
- مربعات check لفتحات القياس: Wake / Pre‑B / Pre‑L / Pre‑D / Bedtime.
- كروت الوجبات الأربع مع شارة ✅ “ضمن الهدف” عند الاستيفاء.
- كارت “علاج الهبوط الصحيح” يظهر تلقائيًا إن تحقق النمط.

**عمود يمين: “النقاط والإنجازات”**
- بطاقة تفصيل نقاط اليوم (قائمة الأسباب الممنوحة اليوم).
- شريط إنجازات (Badges) المكتسبة حديثًا + زر “عرض الكل”.
- سجل آخر 10 عمليات من `rewards_points_ledger` (التاريخ، السبب، النقاط، ارتباط الإجراء).

**أسفل الصفحة:**
- (اختياري) متجر مكافآت: بطاقات عناصر + زر طلب (requires parent approval).
- رسائل الحالة:  
  - “لا نقاط TIR اليوم — القياسات أقل من 4”  
  - “أضِف قياس قبل الوجبة لتحصيل نقاط الروتين”

**فراغات (Empty States):**
- لا بيانات هذا الأسبوع → دعوة لضبط أوقات الوجبات/إدخال أول قياس.

---

## نصوص/أسماء الأسباب (Suggested Labels)
- TIR اليوم (≥80%/≥70%/≥60%)
- لا هبوط شديد اليوم
- فتحة قياس مكتملة (الاستيقاظ/قبل الفطور/قبل الغداء/قبل العشاء/قبل النوم)
- وجبة ضمن الهدف
- سناك ضمن الهدف
- علاج هبوط صحيح
- سلسلة 7 أيام TIR ≥ 70%
- تحسّن HbA1c
- مهمة رعاية مكتملة
- نشاط توعوي مكتمل

---

## ملاحظات تطبيقية
- جميع الحسابات تعتمد **Asia/Kuwait** افتراضيًا؛ يمكن تخصيصها من `user_settings.timezone`.
- واجهة العرض يمكنها دمج النتائج من `rewards_daily_scores` (للسرعة) وسجلّ `rewards_points_ledger` (للتدقيق).
- عند الحفظ في `meals`, خزّني لقطة الحساب في `calc_snapshot` لضمان تفسير سبب منح نقاط الوجبة لاحقًا.

---

## تغيير السلم لاحقًا
- يمكن تغيير أوزان النقاط بسهولة (مصفوفة مرجعية) مع تسجيل تاريخ التعديل في المستودع (CHANGELOG).
